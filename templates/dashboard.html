{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-end justify-content-between gap-3 flex-wrap">
  <div>
    <h1 class="h3 mb-1">Overview</h1>
    <div class="text-muted">
      {% if last_update %}Last balance date: <span class="fw-medium">{{ last_update }}</span>{% else %}No balances yet.{% endif %}
    </div>
  </div>

  <div class="d-flex gap-3 flex-wrap">
    <div class="stat-card">
      <div class="label">Total Balance</div>
      <div class="value">{{ "{:,.2f}".format(total_balance) }}</div>
    </div>
    <div class="stat-card">
      <div class="label">Monthly Incoming (enabled)</div>
      <div class="value">{{ "{:,.2f}".format(total_monthly) }}</div>
    </div>
  </div>
</div>

<hr class="my-4"/>

<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="h6 mb-1">Total balance over time</div>
        <div class="text-muted small">Stacked by account (carry-forward between balance points)</div>
      </div>
    </div>

    <div class="chart-wrap mt-3">
      <canvas id="stackedTotalChart"></canvas>
    </div>
  </div>
</div>

<script>
  const totalLabels = {{ chart_labels|tojson }};
  const totalDatasetsRaw = {{ chart_datasets|tojson }};

  const totalDatasets = totalDatasetsRaw.map(ds => ({
    label: ds.label,
    data: ds.data,
    fill: true,
    borderWidth: 1,
    tension: 0.25,
    pointRadius: 0
  }));

  const ctxTotal = document.getElementById('stackedTotalChart');

  new Chart(ctxTotal, {
    type: 'line',
    data: {
      labels: totalLabels,
      datasets: totalDatasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { enabled: true }
      },
      scales: {
        x: {
          ticks: { maxRotation: 0 },
          grid: { display: false }
        },
        y: {
          stacked: true,
          beginAtZero: true
        }
      }
    }
  });
</script>

<div class="row g-3">
  {% for a in accounts %}
  <div class="col-12 col-md-6 col-lg-4">
    <a class="card account-card h-100 text-decoration-none" href="{{ url_for('account_detail', account_id=a.id) }}">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <div class="text-muted small">{{ a.account_type|upper }}</div>
            <div class="h5 mb-1">{{ a.name }}</div>
            <div class="text-muted small">
              Monthly incoming:
              {% if a.monthly_payment_enabled %}
                <span class="fw-semibold">{{ "{:,.2f}".format(a.monthly_payment) }}</span>
              {% else %}
                <span class="badge text-bg-light border">Off</span>
              {% endif %}
            </div>
          </div>
          <div class="text-end">
            <div class="text-muted small">Current</div>
            <div class="h4 mb-0">{{ "{:,.2f}".format(a.current_balance) }}</div>
          </div>
        </div>
      </div>
    </a>
  </div>
  {% endfor %}

  {% if not accounts %}
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        No accounts yet. Create your first one on the <a href="{{ url_for('accounts_list') }}">Accounts</a> page.
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
